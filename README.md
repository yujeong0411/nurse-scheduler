# NurseScheduler - 응급실 간호사 근무표 자동생성

OR-Tools CP-SAT 솔버 기반 제약조건 최적화 + PyQt6 데스크톱 앱

## 주요 기능

- **자동 근무표 생성**: D/E/N/중2 4종 근무 + 11종 휴무를 28일(4주) 단위로 자동 배정
- **23개 하드 제약조건**: 일일 인원, 역순 금지, 연속근무 제한, 직급/역할 요구 등
- **5개 소프트 목적함수**: D/E/N 공정성, 야간 균등, 주말 균등, 요청 반영
- **수동 수정**: 생성된 근무표를 셀 단위로 편집 (16종 위반 체크)
- **엑셀 가져오기/내보내기**: 규칙 엑셀, 근무신청표, 이전 근무표 가져오기 + 근무표/통계 내보내기
- **공정성 평가**: A~F 등급, 편차/위반 상세 표시
- **앱 내 도움말**: 처음 사용자를 위한 가이드 + F1 단축키로 언제든 접근

## 실행 방법

```bash
# 의존성 설치 (uv 패키지 매니저)
uv sync

# 실행
uv run python main.py

# Windows exe 빌드
build.bat
```

Python 3.12+ / PyQt6 / ortools / openpyxl

## 프로젝트 구조

```
nurse-scheduler/
├── main.py                  ← 실행 진입점
├── engine/
│   ├── models.py            ← 데이터 클래스 (Nurse, Request, Rules, Schedule) + JSON 저장/백업
│   ├── solver.py            ← OR-Tools CP-SAT 솔버 (15종 변수, 23 하드 + 5 소프트)
│   ├── validator.py         ← 수동 수정 시 16종 위반 체크
│   ├── evaluator.py         ← 공정성 평가 (0-100점, A-F 등급, 위반 상세)
│   ├── excel_io.py          ← 엑셀 가져오기/내보내기 (양 형식 날짜 헤더 인식)
│   └── kr_holidays.py       ← 한국 공휴일 감지 (holidays 패키지)
├── ui/
│   ├── styles.py            ← 색상, 스타일시트
│   ├── main_window.py       ← 4탭 메인 윈도우 + 도움말 메뉴
│   ├── setup_tab.py         ← Tab 1: 간호사 관리 (역할/직급/특수조건)
│   ├── request_tab.py       ← Tab 2: 요청사항 달력 (콤보박스 격자)
│   ├── rules_tab.py         ← Tab 3: 규칙 설정 (인원/제한/직급/수면 등)
│   ├── result_tab.py        ← Tab 4: 결과 표시 + 수동 수정 + 통계
│   └── help_dialog.py       ← 사용 가이드 다이얼로그 (6탭)
├── assets/icons/            ← 탭 아이콘 (SVG)
├── data/                    ← JSON 저장 (nurses, rules, requests, schedule, settings)
├── build.bat                ← PyInstaller 빌드 스크립트
├── CLAUDE.md                ← Claude Code 가이드
└── README.md
```

## 근무/휴무 코드

| 구분 | 코드 | 설명 |
|------|------|------|
| 근무 | `D` | 주간 근무 (Day) |
| 근무 | `E` | 저녁 근무 (Evening) |
| 근무 | `N` | 야간 근무 (Night) |
| 근무 | `중2` | 중간 근무 (평일만, 역할 "중2" 지정 간호사만) |
| 휴무 | `주` | 주휴 (고정 요일, 주 1회) |
| 휴무 | `OFF` | 일반 휴무 (주 1회 이상) |
| 휴무 | `POFF` | 임산부 추가 휴무 (4연속 근무 후) |
| 휴무 | `법휴` | 법정공휴일 휴무 |
| 휴무 | `수면` | 수면 휴무 (야간 횟수 기준 자동 발생) |
| 휴무 | `생휴` | 생리 휴무 (여성 월 1회) |
| 휴무 | `휴가` | 연차 휴가 |
| 휴무 | `특휴` | 특별 휴가 |
| 휴무 | `공가` | 공가 |
| 휴무 | `경가` | 경조사 휴가 |
| 휴무 | `보수` | 보수교육 |
| 요청 | `D 제외` / `E 제외` / `N 제외` | 특정 근무 제외 요청 |

## 사용 흐름

1. **설정 탭**: 간호사 목록 등록 (규칙 엑셀 / 신청표 엑셀 불러오기 가능)
2. **요청사항 탭**: 개인별 근무 희망/휴무 요청 입력
3. **규칙설정 탭**: 일일 인원, 연속근무 제한, 직급 요구 등 설정
4. **결과 탭**: 근무표 생성 → 확인/수동수정 → 엑셀 내보내기

---

## 제약조건 상세

### 하드 제약조건 (Hard Constraints) — 반드시 충족

| 번호 | 제약 | 설명 |
|------|------|------|
| H1 | 하루 1배정 | 간호사 1인당 하루에 정확히 1개의 근무/휴무 배정 |
| H2 | 일일 인원 고정 | D/E/N 각각 설정된 인원 수 정확히 배정. 중2는 평일만 배정 |
| H3 | 역순 금지 | D→중2→E→N 순서 위반 금지 (예: E 다음날 D 불가) |
| H3a | N→D 간격 | N 근무 후 D까지 최소 2일 휴무 필요 |
| H4 | 최대 연속 근무 | 기본 5일 연속까지 허용 |
| H5 | 최대 연속 N | 기본 3연속까지 허용 |
| H6 | NN 후 휴무 | N 2연속 후 반드시 2일 휴무 |
| H7 | 월 N 제한 | 1인당 월 최대 N 횟수 (기본 6회) |
| H8 | 확정 요청 매핑 | 주/법휴/휴가/특휴/생휴/수면/공가/경가/보수 요청은 반드시 반영 |
| H9 | 제외 요청 | D 제외/E 제외/N 제외 요청 반드시 반영 |
| H10 | 고정 주휴 | 지정된 요일에 주휴 배정 |
| H10a | 주휴 제한 | 주휴는 고정 주휴일에만 배치 가능 |
| H10b | 법휴 제한 | 법휴는 공휴일에만 배치 가능 |
| H11 | 주당 OFF | 각 주(7일)마다 최소 OFF 1개 보장 |
| H12 | 책임 필수 | D/E/N 각 근무에 책임 간호사 최소 1명 |
| H13 | 시니어 필수 | D/E/N 각 근무에 책임+서브차지 최소 N명 |
| H14 | 역할 누적 제한 | 역할 티어별 동시 근무 인원 상한 (ROLE_TIERS) |
| H15 | 책임만 제한 | "책임만" 역할 간호사 동시 1명 이하 |
| H17 | 임산부 연속 제한 | 임산부는 4연속 근무 제한 |
| H18 | 공휴일 법휴 | 공휴일 비근무 시 법휴만 허용 (고정주휴/하드요청 제외) |
| H19 | 임산부 POFF | 임산부 4연속 근무 후 POFF 추가 |
| H20 | 휴무 편차 제한 | 총 휴무일수 편차 일반 ±2, 주4일제 +4 |

### 소프트 제약조건 (Soft Constraints) — 최적화 목표

| 번호 | 목표 | 가중치 | 설명 |
|------|------|--------|------|
| S1 | 희망 요청 반영 | +30 | OFF/D/E/N 희망 요청을 최대한 반영 |
| S2 | D/E/N 공정성 | -5 | 간호사 간 D/E/N 횟수 편차 최소화 |
| S3 | N 균등 배분 | -8 | 야간근무 횟수 균등 분배 |
| S4 | 주말 균등 배분 | -8 | 주말 근무 횟수 균등 분배 |
| S5 | 일반 간호사 제한 | -3 | 근무당 일반(무직급) 간호사 3명 이하 권고 |

---

## 공정성 평가 시스템

생성된 근무표를 6개 항목으로 자동 평가하여 0~100점 및 등급을 산출합니다.

### 감점 카테고리

| 항목 | 계산 | 최대 감점 |
|------|------|-----------|
| 근무 편차 | (D편차 + E편차 + N편차) × 3 | -30 |
| 야간(N) 편차 | N 편차 × 5 | -15 |
| 주말근무 편차 | 주말근무 편차 × 4 | -15 |
| 역순 패턴 | 역순 발생 건수 × 5 | -15 |
| 요청 미반영 | 미반영률 × 15 | -15 |
| 규칙 위반 | 위반 건수 × 3 | -10 |

### 등급 기준

| 등급 | 점수 범위 | 의미 |
|------|-----------|------|
| **A** | 90점 이상 | 매우 우수 |
| **B+** | 80~89점 | 우수 |
| **B** | 70~79점 | 양호 |
| **C** | 60~69점 | 보통 |
| **D** | 50~59점 | 미흡 |
| **F** | 50점 미만 | 부적합 |

---

## 엑셀 연동

### 내보내기 (2시트 구조)

| 시트 | 내용 |
|------|------|
| **근무표** | 간호사 × 28일 격자 + 휴가잔여/생휴/잔여수면 컬럼 |
| **통계** | 개인별 D/E/N/중2/OFF 횟수, 총근무일, 편차 등 |

### 가져오기 (3종)

| 종류 | 파일 | 용도 |
|------|------|------|
| **규칙 엑셀** | 근무표_규칙.xlsx | 간호사 역할/직급/특수조건 일괄 설정 |
| **근무 신청표** | 신청표 엑셀 | 개인별 요청사항 달력 형태로 가져오기 |
| **이전 근무표** | 이전 달 근무표 | 전월 마지막 5일 근무 + N 횟수 자동 반영 |

날짜 헤더는 `"1일"` 형식과 `"1"` 형식 모두 인식합니다.

---

## 수면 휴무 계산

수면 휴무는 야간(N) 근무 횟수에 따라 자동으로 발생합니다.

### 2개월 페어 구조

수면은 **고정 2개월 단위**로 계산됩니다:
- 1-2월, 3-4월, 5-6월, 7-8월, 9-10월, 11-12월

### 발생 조건

| 구분 | 조건 | 적용 시점 |
|------|------|-----------|
| **월별 기준** | 해당 월 N ≥ 7회 (기본값) | 매월 |
| **2개월 합산** | 전월 N + 이번달 N ≥ 11회 (기본값) | 짝수월(페어 둘째 달)만 |

### 이월 로직

- **홀수월** (페어 첫 달): 발생한 수면은 `pending_sleep`으로 다음 달에 이월
- **짝수월** (페어 둘째 달): 이월분 + 이번달 발생분 합산하여 사용
- **잔여수면** = (이번달 발생 + 이월분) - 사용한 수면 수

### 예시

> 3월에 N을 7회 근무 → 수면 1개 발생 → 4월로 이월 (`pending_sleep = true`)
> 4월에 N을 4회 근무 → 3+4월 합산 11회 ≥ 11 → 추가 수면 발생
> 4월에 이월분 + 추가분 합산하여 수면 배정
